apiVersion: v1
kind: Pod
metadata:
  name: nginx
  labels:
    name: nginx
spec:
  containers:
  - name: nginx
    image: nginx:1.21-alpine
    resources:
      limits:
        memory: "500Mi"
        cpu: "250m"
    ports:
      - containerPort: 80
    volumeMounts:
      - mountPath: /var/log/nginx
        name: log-vol
      - mountPath: /etc/nginx
        name: nginx-vol
  - name: fluentd
    image: fluentd:latest
    resources: 
      requests:
        cpu: "50m"
        memory: "100Mi" 
      limits:
        cpu: "500m"
        memory: "500Mi"         
    volumeMounts:
    - mountPath: /logs
      name: log-vol
    - name: fluentd-vol
      mountPath: "/fluentd/etc"
  volumes:
    - name: log-vol
      emptyDir:
        {}
    - name: nginx-vol
      configMap:
        name: cfg-nginx
    - name: fluentd-vol
      configMap:
        name: cfg-fluentd
---
apiVersion: v1
kind: Service
metadata:
  name: svc-nginx
spec:
  selector:
    name: nginx
  ports:
  - port: 8081
    targetPort: 80
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: cfg-nginx
data:
  nginx.conf: |
    user  nginx;
    worker_processes  1;
    error_log  /var/log/nginx/error.log warn;
    pid        /var/run/nginx.pid;
    events {
        worker_connections  1024;
    }
    http {
        log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                          '$status $body_bytes_sent "$http_referer" '
                          '"$http_user_agent" "$http_x_forwarded_for"';
        # Path to access.log & error.log
        access_log /var/log/nginx/access.log  main;
        error_log /var/log/nginx/error.log  warn;
        sendfile        on;
        keepalive_timeout  65;
        gzip  on;
        upstream backend {
            # must match the target service name
            server svc-wordpress;
        }
        server {
            listen       80;
            location / {
                # $http_host is the host name that users seen on the browser URL
                # and it equals to `HTTP_HOST` request header.
                proxy_set_header Host $http_host;
                # You have to change this according to your setup.
                proxy_pass http://svc-wordpress:8080;
                # Modify `Location` of 301 or 302 HTTP response, so
                # that the browser will follow the correct location.
                proxy_redirect ~^http://[^/]*/(.*) http://$http_host/$1;
            }
        }
    }
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: cfg-fluentd
data:
   fluent.conf: |
     <source>
       type tail
       path /logs/**/access.log
       tag nginx.access
       format nginx
     </source>
     <source>
       @type tail
       format /^(?<time>\d{4}/\d{2}/\d{2} \d{2}:\d{2}:\d{2}) \[(?<log_level>\w+)\] (?<pid>\d+).(?<tid>\d+): (?<message>.*)$/
       tag nginx.error
       path /logs/**/error.log
     </source>
     <match nginx.access>
       @type stdout
     </match>
     <match nginx.error>
       @type stdout
     </match>
